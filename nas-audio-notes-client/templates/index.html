<!DOCTYPE html>
<html lang="zh-CN" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Audio Notes | æ™ºèƒ½è¯­éŸ³ç¬”è®°</title>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        },
                        primary: {
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                        },
                        accent: {
                            400: '#2dd4bf',
                            500: '#14b8a6',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #111827;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        /* ç»ç’ƒæ‹Ÿæ€æ•ˆæœ */
        .glass {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(31, 41, 55, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.03);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            background: rgba(31, 41, 55, 0.6);
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        /* éœ“è™¹å…‰æ•ˆ */
        .neon-text {
            text-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }

        .status-dot {
            box-shadow: 0 0 8px currentColor;
        }

        /* èŠå¤©æ°”æ³¡ */
        .chat-bubble {
            position: relative;
            z-index: 1;
        }

        .chat-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 100%);
            z-index: -1;
            border-radius: inherit;
        }

        body {
            background-color: #030712;
            background-image:
                radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(20, 184, 166, 0.08) 0%, transparent 25%);
            color: #f3f4f6;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }


        /* Timeline styles */
        .timeline-year {
            font-size: 13px;
            font-weight: 500;
            color: #9ca3af;
            transition: color 0.2s;
        }

        .timeline-dot {
            width: 4px;
            height: 4px;
            background: #4b5563;
            border-radius: 50%;
            transition: all 0.2s;
            cursor: pointer;
        }

        .timeline-dot:hover {
            background: #60a5fa;
            transform: scale(1.5);
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {

            /* éšè—ä¾§è¾¹æ ,ä½¿ç”¨å…¨å±å¸ƒå±€ */
            aside {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            aside.mobile-open {
                left: 0;
                z-index: 1001 !important;
            }

            /* æ·»åŠ é®ç½©å±‚ */
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .mobile-overlay.active {
                display: block;
            }

            /* ä¸»å†…å®¹åŒºå æ»¡å±å¹• */
            main {
                width: 100%;
            }

            /* æ·»åŠ æ±‰å ¡èœå•æŒ‰é’® */
            .mobile-menu-btn {
                display: flex !important;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 100;
                width: 48px;
                height: 48px;
                background: rgba(99, 102, 241, 0.9);
                border-radius: 12px;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
            }

            /* å¡ç‰‡ç½‘æ ¼è°ƒæ•´ä¸ºå•åˆ— */
            #dashboard-content {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            /* æ—¶é—´è½´ä¼˜åŒ– - ç¼©å°å®½åº¦ */
            #timeline-container {
                width: 40px !important;
            }

            #timeline {
                padding: 1rem 0.25rem !important;
            }

            .timeline-year {
                font-size: 10px !important;
                writing-mode: vertical-rl;
                text-orientation: mixed;
            }

            .timeline-dot {
                width: 3px !important;
                height: 3px !important;
            }

            /* æ—¥æœŸç­›é€‰å™¨å‚ç›´å¸ƒå±€ */
            header .flex.gap-3 {
                flex-direction: column !important;
                align-items: stretch !important;
                width: 100%;
                gap: 0.5rem !important;
            }

            header .flex.gap-3>div {
                width: 100%;
            }

            header .flex.gap-3 input,
            header .flex.gap-3 button {
                width: 100%;
                min-height: 44px;
            }

            /* é¡¶éƒ¨headerä¼˜åŒ– */
            header.flex.justify-between {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1rem;
            }

            /* è°ƒæ•´å­—ä½“å¤§å° */
            h2 {
                font-size: 1.5rem !important;
            }

            h3 {
                font-size: 1.125rem !important;
            }

            /* å¢å¤§è§¦æ‘¸ç›®æ ‡ */
            .nav-btn {
                min-height: 48px;
                padding: 0.75rem 1rem !important;
            }

            button {
                min-height: 44px;
                padding: 0.75rem 1rem !important;
                font-size: 0.875rem;
            }

            /* ä¼˜åŒ–èŠå¤©æ°”æ³¡ */
            .chat-bubble {
                max-width: 90% !important;
            }

            /* éŸ³é¢‘æ’­æ”¾æŒ‰é’®å¢å¤§ */
            button[onclick^="playAudio"] {
                width: 32px !important;
                height: 32px !important;
                min-height: 32px !important;
            }

            /* è°ƒæ•´padding */
            .p-8 {
                padding: 1rem !important;
            }

            .p-6 {
                padding: 0.75rem !important;
            }

            /* ç»Ÿè®¡åˆ†æé¡µé¢ä¼˜åŒ– */
            #analysis-content {
                grid-template-columns: 1fr !important;
            }

            #analysis-content .grid-cols-2 {
                grid-template-columns: 1fr !important;
            }

            /* å£°çº¹ç®¡ç†é¡µé¢ä¼˜åŒ– */
            #speaker-list {
                grid-template-columns: 1fr !important;
            }

            .glass-card {
                padding: 1rem !important;
            }

            /* è¡¨å•è¾“å…¥æ¡†ä¼˜åŒ– */
            input[type="text"],
            input[type="date"],
            input[type="file"] {
                font-size: 16px !important;
                /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
                min-height: 44px;
            }

            /* ä¼˜åŒ–æ»šåŠ¨ */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }

            /* å¡ç‰‡é—´è·ä¼˜åŒ– */
            .space-y-8>*+* {
                margin-top: 1.5rem !important;
            }

            /* ç§»åŠ¨ç«¯é¡¶éƒ¨ç•™å‡ºæ±‰å ¡èœå•ç©ºé—´ */
            #view-dashboard>header:first-child,
            #view-chat>div>div>header:first-child,
            #view-analysis>header:first-child,
            #view-speaker>header:first-child {
                padding-top: 4rem !important;
            }
        }

        /* æ¡Œé¢ç«¯éšè—æ±‰å ¡èœå• */
        .mobile-menu-btn {
            display: none;
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden selection:bg-primary-500 selection:text-white">

    <!-- ä¾§è¾¹æ  -->

    <!-- ç§»åŠ¨ç«¯æ±‰å ¡èœå• -->
    <div class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fa-solid fa-bars text-white text-xl"></i>
    </div>

    <!-- ç§»åŠ¨ç«¯é®ç½©å±‚ -->
    <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>

    <aside class="w-64 glass flex flex-col border-r border-gray-800 z-20">
        <div class="p-6 flex items-center gap-3">
            <div
                class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary-500 to-purple-600 flex items-center justify-center shadow-lg shadow-primary-500/20">
                <i class="fa-solid fa-wave-square text-white text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight text-white">Audio Notes</h1>
                <p class="text-xs text-gray-400">AI æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹</p>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2 mt-4">
            <button onclick="switchTab('dashboard')" id="nav-dashboard"
                class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group active">
                <i class="fa-solid fa-comments text-lg group-hover:text-primary-400 transition-colors"></i>
                <span class="font-medium">æ•°æ®æ¦‚è§ˆ</span>
            </button>
            <button onclick="switchTab('chat')" id="nav-chat"
                class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group">
                <i class="fa-solid fa-comments text-lg group-hover:text-accent-400 transition-colors"></i>
                <span class="font-medium">æ—¶å…‰å¯¹è¯</span>
            </button>
            <button onclick="switchTab('analysis')" id="nav-analysis"
                class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group">
                <i class="fa-solid fa-chart-pie text-lg group-hover:text-purple-400 transition-colors"></i>
                <span class="font-medium">ç»Ÿè®¡åˆ†æ</span>
            </button>
            <button onclick="switchTab('speaker')" id="nav-speaker"
                class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all group">
                <i class="fa-solid fa-chart-pie text-lg group-hover:text-pink-400 transition-colors"></i>
                <span class="font-medium">å£°çº¹ç®¡ç†</span>
            </button>
        </nav>

        <div class="p-4 mt-auto">
            <div class="glass-card rounded-xl p-4 space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-medium text-gray-400">ASR æœåŠ¡</span>
                    <span id="status-asr" class="flex h-2 w-2 rounded-full bg-green-500 status-dot"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs font-medium text-gray-400">å¾…å¤„ç†</span>
                    <span id="status-files"
                        class="text-xs font-bold text-white bg-gray-700 px-2 py-0.5 rounded-full">0</span>
                </div>
                <div class="h-px bg-gray-700/50 my-2"></div>
                <div class="text-[10px] text-gray-500 font-mono truncate" id="log-display">
                    ç³»ç»Ÿå°±ç»ª...
                </div>
            </div>
        </div>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-1 relative overflow-hidden flex flex-col">
        <!-- é¡¶éƒ¨å…‰æ™• -->
        <div
            class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-primary-900/10 to-transparent pointer-events-none">
        </div>

        <!-- è§†å›¾å®¹å™¨ -->
        <div id="view-dashboard" class="view-container flex-1 overflow-y-auto p-8 space-y-8 animate-fade-in active">
            <header class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-white mb-2">æ¦‚è§ˆ</h2>
                    <p class="text-gray-400">æœ€è¿‘çš„å½•éŸ³ä¸è½¬å½•è®°å½•</p>
                </div>
                <div class="flex gap-3 items-end">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="filter-start-date"
                            class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500/20">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="filter-end-date"
                            class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500/20">
                    </div>
                    <button onclick="applyDateFilter()"
                        class="px-4 py-2 bg-accent-500 hover:bg-accent-400 text-white rounded-lg text-sm font-medium transition-all duration-300 shadow-lg shadow-accent-500/20 hover:shadow-accent-500/40 hover:scale-105">
                        <i class="fa-solid fa-filter mr-2"></i>ç­›é€‰
                    </button>
                    <button onclick="clearDateFilter()"
                        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm font-medium transition-all">
                        <i class="fa-solid fa-rotate-left mr-2"></i>æ¸…é™¤
                    </button>
                </div>
                <button onclick="loadMore()"
                    class="group px-5 py-2.5 rounded-xl bg-gradient-to-r from-primary-600 to-primary-500 hover:from-primary-500 hover:to-primary-400 text-sm font-medium text-white transition-all duration-300 shadow-lg shadow-primary-500/20 hover:shadow-primary-500/40 hover:scale-105 border border-primary-400/20">
                    <i
                        class="fa-solid fa-rotate-right mr-2 group-hover:rotate-180 transition-transform duration-500"></i>åˆ·æ–°æ•°æ®
                </button>
            </header>

            <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-10">
                <!-- å¡ç‰‡å°†é€šè¿‡JSæ’å…¥ -->
            </div>
            <div id="loading-indicator" class="text-center py-8 hidden">
                <i class="fa-solid fa-circle-notch fa-spin text-primary-500 text-2xl"></i>
            </div>
        </div>

        <div id="view-chat" class="view-container flex-1 overflow-hidden p-0 hidden">
            <div class="w-full h-full flex">
                <!-- Main content area -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <div
                        class="max-w-4xl mx-auto w-full h-full flex flex-col bg-gray-900/30 border-x border-gray-800/50">
                        <header class="p-6 border-b border-gray-800/50 glass sticky top-0 z-10 backdrop-blur-xl">
                            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fa-regular fa-clock text-accent-400"></i> æ—¶å…‰å¯¹è¯
                            </h2>
                            <div id="chat-date-range" class="mt-2 text-sm text-gray-400">
                                <i class="fa-solid fa-calendar-days text-gray-500 mr-2"></i>
                                <span id="chat-date-range-text">æ‰€æœ‰è®°å½•</span>
                            </div>
                        </header>
                        <div id="chat-content" class="flex-1 p-6 space-y-8 pb-20 overflow-y-auto">
                            <!-- å¯¹è¯å†…å®¹ -->
                        </div>
                    </div>
                </div>

                <!-- Google Photos-style Timeline -->
                <div id="timeline-container" class="w-20 bg-transparent flex flex-col relative cursor-pointer">
                    <div id="timeline" class="flex-1 overflow-y-auto relative py-8 px-2">
                        <!-- Vertical line -->
                        <div class="absolute left-1/2 top-0 bottom-0 w-px bg-gray-700/20 transform -translate-x-1/2">
                        </div>

                        <!-- Time markers -->
                        <div id="timeline-markers" class="relative">
                            <!-- Markers will be generated by JS -->
                        </div>

                        <!-- Current position indicator -->
                        <div id="timeline-indicator"
                            class="absolute left-1/2 transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 ease-out pointer-events-none z-10"
                            style="top: 0%;">
                            <div class="w-3 h-3 bg-blue-500 rounded-full shadow-lg shadow-blue-500/50"></div>
                        </div>
                    </div>
                </div>

                <!-- Floating tooltip for timeline -->
                <div id="timeline-hover-tooltip"
                    style="position: fixed; opacity: 0; pointer-events: none; z-index: 1000; background: rgba(17, 24, 39, 0.95); color: white; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; white-space: nowrap; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                </div>
            </div>
        </div>

        <div id="view-analysis" class="view-container flex-1 overflow-y-auto p-8 hidden">
            <header class="mb-8">
                <h2 class="text-3xl font-bold text-white mb-2">æ•°æ®æ´å¯Ÿ</h2>
                <p class="text-gray-400">è¯´è¯äººç»Ÿè®¡ä¸è¶‹åŠ¿åˆ†æ</p>
            </header>
            <div id="analysis-content" class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-10">
                <!-- æƒ…æ„Ÿæ›²çº¿å›¾ -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-heart-pulse text-pink-400"></i>
                        æƒ…æ„Ÿæ›²çº¿å›¾
                    </h3>
                    <div id="emotion-chart" style="width: 100%; height: 400px;"></div>
                </div>

                <!-- å¯¹è¯çƒ­åŠ›å›¾ -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-fire text-orange-400"></i>
                        å¯¹è¯çƒ­åŠ›å›¾
                    </h3>
                    <div id="heatmap-chart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>

        <div id="view-speaker" class="view-container flex-1 overflow-y-auto p-8 hidden">
            <header class="mb-8">
                <h2 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                    <i class="fa-solid fa-microphone text-pink-400"></i>
                    å£°çº¹ç®¡ç†
                </h2>
                <p class="text-gray-400">æ³¨å†Œå’Œç®¡ç†è¯´è¯äººå£°çº¹</p>
            </header>

            <!-- æ³¨å†ŒåŒºåŸŸ -->
            <div class="glass-card rounded-2xl p-8 mb-8">
                <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-user-plus text-primary-400"></i>
                    æ³¨å†Œæ–°è¯´è¯äºº
                </h3>

                <form id="register-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            <i class="fa-solid fa-signature mr-2"></i>è¯´è¯äººå§“å
                        </label>
                        <input type="text" id="speaker-name" placeholder="è¯·è¾“å…¥å§“å"
                            class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 transition-all"
                            required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            <i class="fa-solid fa-file-audio mr-2"></i>éŸ³é¢‘æ–‡ä»¶ (3-10ç§’æ¸…æ™°è¯­éŸ³)
                        </label>
                        <div class="relative">
                            <input type="file" id="audio-file" accept="audio/*" class="hidden" required>
                            <button type="button" onclick="document.getElementById('audio-file').click()"
                                class="w-full px-4 py-3 bg-gray-800 border-2 border-dashed border-gray-600 rounded-xl text-gray-400 hover:border-primary-500 hover:text-primary-400 transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
                                <span id="file-name">ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</span>
                            </button>
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full px-6 py-4 bg-gradient-to-r from-primary-600 to-primary-500 hover:from-primary-500 hover:to-primary-400 text-white font-medium rounded-xl transition-all duration-300 shadow-lg shadow-primary-500/20 hover:shadow-primary-500/40 hover:scale-105 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-fingerprint"></i>
                        <span>æ³¨å†Œå£°çº¹</span>
                    </button>
                </form>

                <div id="register-status" class="mt-4 hidden"></div>
            </div>

            <!-- å·²æ³¨å†Œè¯´è¯äººåˆ—è¡¨ -->
            <div class="glass-card rounded-2xl p-8">
                <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-users text-accent-400"></i>
                    å·²æ³¨å†Œè¯´è¯äºº
                </h3>

                <div id="speaker-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- è¯´è¯äººå¡ç‰‡å°†é€šè¿‡JSæ’å…¥ -->
                </div>
            </div>
        </div>

        <div id="view-speaker" class="view-container flex-1 overflow-hidden p-0 hidden">
            <iframe src="/register_page" style="width:100%; height:100%; border:none;"></iframe>
        </div>
    </main>

    <script>
        // çŠ¶æ€ç®¡ç†
        let lastDataFingerprint = "";
        const speakerColorMap = {};
        const colors = [
            'text-blue-400 border-blue-500/30 bg-blue-500/10',
            'text-emerald-400 border-emerald-500/30 bg-emerald-500/10',
            'text-purple-400 border-purple-500/30 bg-purple-500/10',
            'text-amber-400 border-amber-500/30 bg-amber-500/10',
            'text-rose-400 border-rose-500/30 bg-rose-500/10',
            'text-cyan-400 border-cyan-500/30 bg-cyan-500/10',
        ];
        let nextColorIndex = 0;

        // æ‡’åŠ è½½çŠ¶æ€
        let currentOffset = 0;
        const pageSize = 20;
        let isLoading = false;
        let hasMore = true;
        let allItems = [];

        // åˆ‡æ¢è§†å›¾
        function switchTab(tabName) {
            document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + tabName).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('bg-white/10', 'text-white', 'shadow-lg');
                el.classList.add('text-gray-400');
            });

            const activeBtn = document.getElementById('nav-' + tabName);
            activeBtn.classList.remove('text-gray-400');
            activeBtn.classList.add('bg-white/10', 'text-white', 'shadow-lg');

            // Initialize timeline when switching to chat view
            if (tabName === 'chat') {
                setTimeout(initTimeline, 100);
            }
        }

        // åˆå§‹åŒ–å¯¼èˆªçŠ¶æ€
        switchTab('dashboard');

        function getSpeakerStyle(spk) {
            if (!speakerColorMap[spk]) {
                speakerColorMap[spk] = colors[nextColorIndex % colors.length];
                nextColorIndex++;
            }
            return speakerColorMap[spk];
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', {
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        function parseFilenameTime(filename) {
            // å°è¯•ä»æ–‡ä»¶åè§£ææ—¶é—´
            // æ”¯æŒæ ¼å¼: TermuxAudioRecording_2025-11-20_14-33-08
            // æ”¯æŒæ ¼å¼: recording-20251115-131250

            // æ ¼å¼1: TermuxAudioRecording_YYYY-MM-DD_HH-mm-ss
            let match = filename.match(/(\d{4})-(\d{2})-(\d{2})_(\d{2})-(\d{2})-(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]}T${match[4]}:${match[5]}:${match[6]}`;
            }

            // æ ¼å¼2: recording-YYYYMMDD-HHmmss
            match = filename.match(/recording-(\d{8})-(\d{6})/);
            if (match) {
                const date = match[1];  // YYYYMMDD
                const time = match[2];  // HHmmss
                return `${date.substring(0, 4)}-${date.substring(4, 6)}-${date.substring(6, 8)}T${time.substring(0, 2)}:${time.substring(2, 4)}:${time.substring(4, 6)}`;
            }

            return null;
        }

        function processStats(items) {
            // ç®€å•çš„æ•°æ®é¢„å¤„ç†
            return items.map(item => {
                item.date_group = item.created_at ? item.created_at.split('T')[0] : 'Unknown';
                return item;
            });
        }

        // æ¸²æŸ“ä»ªè¡¨ç›˜
        function renderDashboard(items) {
            const container = document.getElementById('dashboard-content');
            container.innerHTML = ""; // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“æ‰€æœ‰é¡¹

            let html = "";
            items.forEach((item, index) => {
                // æå–æ‘˜è¦ (å‰100å­—)
                let summary = item.full_text || "æ— å†…å®¹";
                if (summary.length > 100) summary = summary.substring(0, 100) + "...";

                // æå–å‚ä¸è€…
                const speakers = new Set();
                item.segments.forEach(s => speakers.add(s.spk));
                const speakerTags = Array.from(speakers).map(s => {
                    const style = getSpeakerStyle(s);
                    // æå–é¢œè‰²ç±»åä¸­çš„ text-xxx
                    const colorClass = style.split(' ')[0];
                    return `<span class="text-xs font-medium ${colorClass} bg-gray-800/50 px-2 py-1 rounded-md border border-gray-700/50">${s}</span>`;
                }).join('');

                // ç»Ÿè®¡æƒ…æ„Ÿåˆ†å¸ƒ
                const emotionStats = {};
                item.segments.forEach(s => {
                    const emo = s.emotion || 'neutral';
                    emotionStats[emo] = (emotionStats[emo] || 0) + 1;
                });

                // ç”Ÿæˆæƒ…æ„Ÿæ ‡ç­¾ (æ˜¾ç¤ºæ‰€æœ‰æƒ…æ„ŸåŒ…æ‹¬neutralï¼Œç”¨äºæµ‹è¯•)
                const emotionTags = Object.entries(emotionStats)
                    // .filter(([emo]) => emo !== 'neutral')  // ä¸´æ—¶æ³¨é‡Šä»¥æµ‹è¯•
                    .map(([emo, count]) => {
                        const icon = getEmotionIcon(emo);
                        return `<span class="text-xs px-2 py-1 rounded-md bg-purple-500/10 text-purple-400 border border-purple-500/30 flex items-center gap-1">
                            <span>${icon}</span>
                            <span>${emo}</span>
                            <span class="text-[10px] opacity-70">Ã—${count}</span>
                        </span>`;
                    }).join('');

                html += `
                <div class="glass-card rounded-2xl p-6 flex flex-col h-full animate-slide-up hover:scale-105 transition-transform duration-300" style="animation-delay: ${index * 50}ms">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700">
                                <i class="fa-solid fa-file-audio text-primary-400"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-white text-sm truncate w-40" title="${item.filename}">${item.filename}</h3>
                                <span class="text-xs text-gray-500">${formatTime(parseFilenameTime(item.filename) || item.created_at)}</span>
                            </div>
                        </div>
                        <span class="text-xs font-mono text-gray-600 bg-gray-900 px-2 py-1 rounded">ID: ${item.id}</span>
                    </div>
                    
                    <div class="flex-1 mb-4">
                        <p class="text-gray-400 text-sm leading-relaxed line-clamp-3">${summary}</p>
                    </div>
                    
                    <div class="space-y-2 mt-auto pt-4 border-t border-gray-800/50">
                        <div class="flex flex-wrap gap-2">
                            ${speakerTags || '<span class="text-xs text-gray-600">æ— è¯´è¯äºº</span>'}
                        </div>
                        ${emotionTags ? `<div class="flex flex-wrap gap-2 pt-2 border-t border-gray-800/30">
                            ${emotionTags}
                        </div>` : ''}
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        }

        // æ¸²æŸ“èŠå¤©è§†å›¾
        function renderChat(items) {
            const container = document.getElementById('chat-content');
            if (currentOffset === 0) container.innerHTML = "";

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groups = {};
            items.slice(currentOffset).forEach(item => {
                if (!groups[item.date_group]) groups[item.date_group] = [];
                groups[item.date_group].push(item);
            });

            let html = "";

            // å¦‚æœæ˜¯è¿½åŠ åŠ è½½ï¼Œä¸éœ€è¦é‡æ–°æ¸²æŸ“æ—¥æœŸå¤´ï¼ˆç®€åŒ–å¤„ç†ï¼Œè¿™é‡Œå¯èƒ½éœ€è¦ä¼˜åŒ–ï¼Œä½†æš‚ä¸”å¦‚æ­¤ï¼‰
            // å®é™…ä¸Šï¼Œä¸ºäº†ä¿æŒæ—¶é—´çº¿æ­£ç¡®ï¼Œæˆ‘ä»¬åº”è¯¥é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨æˆ–è€…ç²¾ç»†æ§åˆ¶ã€‚
            // é‰´äº allItems åŒ…å«äº†æ‰€æœ‰æ•°æ®ï¼Œæˆ‘ä»¬è¿™é‡Œç®€å•åœ°é‡æ–°æ¸²æŸ“æ•´ä¸ª allItems ä¼šæ›´å®‰å…¨ï¼Œ
            // ä½†ä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬åªæ¸²æŸ“æ–°å¢éƒ¨åˆ†ã€‚
            // ä¿®æ­£ï¼šrenderChat æ¥æ”¶çš„æ˜¯ allItemsï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…¨é‡æ¸²æŸ“ï¼Œæˆ–è€…ä¼˜åŒ–ã€‚
            // ä¸ºäº†ç®€å•ä¸”ä¿è¯é¡ºåºæ­£ç¡®ï¼Œæˆ‘ä»¬æ¸…ç©ºå¹¶å…¨é‡æ¸²æŸ“ allItemsã€‚

            container.innerHTML = ""; // æ¸…ç©ºé‡ç»˜ï¼Œç¡®ä¿é¡ºåº

            // é‡æ–°åˆ†ç»„ allItems
            const allGroups = {};
            allItems.forEach(item => {
                if (!allGroups[item.date_group]) allGroups[item.date_group] = [];
                allGroups[item.date_group].push(item);
            });

            Object.keys(allGroups).sort().reverse().forEach(date => {
                // å¯¹åŒä¸€å¤©å†…çš„è®°å½•æŒ‰æ–‡ä»¶åæ—¶é—´ä¸¥æ ¼å€’åºæ’åˆ—(æœ€æ–°çš„åœ¨ä¸Šé¢)
                allGroups[date].sort((a, b) => {
                    const timeA = parseFilenameTime(a.filename) || a.created_at;
                    const timeB = parseFilenameTime(b.filename) || b.created_at;
                    return new Date(timeB) - new Date(timeA);  // å€’åº: æ–° - æ—§
                });

                html += `
                <div class="relative flex items-center justify-center my-8" data-date="${date}">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-800"></div>
                    </div>
                    <div class="relative bg-gray-900 px-4 py-1 rounded-full border border-gray-800 text-xs font-medium text-gray-500">
                        ${date}
                    </div>
                </div>`;

                allGroups[date].forEach(item => {
                    // æ–‡ä»¶å¤´ - æ·»åŠ data-file-timeå±æ€§ç”¨äºæ—¶é—´è½´
                    const fileTime = parseFilenameTime(item.filename) || item.created_at;
                    const fileDate = new Date(fileTime);
                    const fileYearMonth = `${fileDate.getFullYear()}-${String(fileDate.getMonth() + 1).padStart(2, '0')}`;

                    html += `
                    <div class="mb-8 animate-fade-in" data-file-time="${fileTime}" data-year-month="${fileYearMonth}">
                        <div class="flex items-center gap-2 mb-4 px-4">
                            <i class="fa-solid fa-record-vinyl text-gray-600 text-xs"></i>
                            <span class="text-xs font-mono text-gray-500">${item.filename.replace("TermuxAudioRecording_", "").replace("recording-", "").substring(0, 30)}</span>
                            <span class="text-xs text-gray-600 ml-auto">${formatTime(fileTime)}</span>
                        </div>
                    `;

                    let lastSpk = null;
                    item.segments.forEach(seg => {
                        const style = getSpeakerStyle(seg.spk);
                        // æå–é¢œè‰²
                        const textColor = style.match(/text-(\w+)-400/)[1]; // e.g. blue
                        const isMe = seg.spk === 'Me'; // å‡è®¾æœ‰ 'Me'ï¼Œç›®å‰æ²¡æœ‰ï¼Œé¢„ç•™

                        const showAvatar = seg.spk !== lastSpk;
                        lastSpk = seg.spk;

                        html += `
                        <div class="flex gap-4 mb-2 ${showAvatar ? 'mt-4' : ''} px-2 hover:bg-white/5 rounded-lg transition-colors p-2 -mx-2">
                            <div class="w-10 flex-shrink-0 flex flex-col items-center">
                                ${showAvatar ? `
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-${textColor}-500 to-${textColor}-700 border-2 border-${textColor}-400/30 flex items-center justify-center shadow-lg shadow-${textColor}-500/20">
                                    <span class="text-sm font-bold text-white">${seg.spk.substring(0, 1).toUpperCase()}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                ${showAvatar ? `
                                <div class="flex items-baseline gap-2 mb-1">
                                    <span class="text-sm font-bold text-gray-200">${seg.spk.replace("TermuxAudioRecording_", "").replace("recording-", "").substring(0, 25)}</span>
                                    <span class="text-[10px] text-gray-600">${formatTime(item.created_at)}</span>
                                </div>
                                ` : ''}
                                <div class="text-gray-300 leading-relaxed text-sm flex items-start gap-2">
                                    <span class="flex-1">${seg.text}</span>
                                    ${seg.segment_audio_path && !seg.segment_audio_path.includes('temp') && seg.segment_audio_path.startsWith('/') ?
                                `<button onclick="playAudio('${seg.segment_audio_path}')" class="flex-shrink-0 w-6 h-6 rounded-full bg-primary-500/20 hover:bg-primary-500/40 border border-primary-400/30 flex items-center justify-center transition-all duration-200 hover:scale-110 group" title="æ’­æ”¾éŸ³é¢‘">
                                            <i class="fa-solid fa-play text-[10px] text-primary-300 group-hover:text-primary-200"></i>
                                        </button>` : ''}
                                    ${seg.emotion ?
                                `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium bg-purple-500/10 text-purple-300 ml-2 border border-purple-500/30">
                                            <span>${getEmotionIcon(seg.emotion)}</span>
                                            <span>${seg.emotion}</span>
                                        </span>` : ''}
                                </div>
                                ${seg.whisper_text ?
                                `<div class="text-blue-500 text-xs mt-1 pl-4 border-l-2 border-blue-700/50">
                                        <span class="text-blue-600">â†ªï¸ Whisper: </span>${seg.whisper_text}
                                    </div>` : ''}
                                ${seg.sensevoice_text ?
                                `<div class="text-purple-500 text-xs mt-1 pl-4 border-l-2 border-purple-700/50">
                                        <span class="text-purple-400">ğŸ­ SenseVoice: </span>${seg.sensevoice_text}
                                    </div>` : ''}
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                });
            });

            container.innerHTML = html;
        }

        // å¢é‡æ¸²æŸ“ï¼šå°†æ–°é¡¹æ·»åŠ åˆ°é¡¶éƒ¨
        function prependNewItems(newItems) {
            // ä¸ºæ¯ä¸ªè§†å›¾æ·»åŠ æ–°å¡ç‰‡
            prependToDashboard(newItems);
            prependToChat(newItems);
            // åˆ†æè§†å›¾éœ€è¦å…¨é‡é‡ç»˜ï¼Œå› ä¸ºæ¶‰åŠç»Ÿè®¡æ±‡æ€»
            renderAnalysis(allItems);
        }

        // åœ¨ä»ªè¡¨ç›˜é¡¶éƒ¨æ·»åŠ æ–°å¡ç‰‡
        function prependToDashboard(newItems) {
            const container = document.getElementById('dashboard-content');
            if (!container) return;

            let html = "";
            newItems.forEach((item, index) => {
                // æå–æ‘˜è¦ (å‰100å­—)
                let summary = item.full_text || "æ— å†…å®¹";
                if (summary.length > 100) summary = summary.substring(0, 100) + "...";

                // æå–å‚ä¸è€…
                const speakers = new Set();
                item.segments.forEach(s => speakers.add(s.spk));
                const speakerTags = Array.from(speakers).map(s => {
                    const style = getSpeakerStyle(s);
                    const colorClass = style.split(' ')[0];
                    return `<span class="text-xs font-medium ${colorClass} bg-gray-800/50 px-2 py-1 rounded-md border border-gray-700/50">${s}</span>`;
                }).join('');

                // ç»Ÿè®¡æƒ…æ„Ÿåˆ†å¸ƒ
                const emotionStats = {};
                item.segments.forEach(s => {
                    const emo = s.emotion || 'neutral';
                    emotionStats[emo] = (emotionStats[emo] || 0) + 1;
                });

                const emotionTags = Object.entries(emotionStats)
                    .map(([emo, count]) => {
                        const icon = getEmotionIcon(emo);
                        return `<span class="text-xs px-2 py-1 rounded-md bg-purple-500/10 text-purple-400 border border-purple-500/30 flex items-center gap-1">
                            <span>${icon}</span>
                            <span>${emo}</span>
                            <span class="text-[10px] opacity-70">Ã—${count}</span>
                        </span>`;
                    }).join('');

                html += `
                <div class="glass-card rounded-2xl p-6 flex flex-col h-full animate-slide-up hover:scale-105 transition-transform duration-300" style="animation-delay: ${index * 50}ms">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700">
                                <i class="fa-solid fa-file-audio text-primary-400"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-white text-sm truncate w-40" title="${item.filename}">${item.filename}</h3>
                                <span class="text-xs text-gray-500">${formatTime(parseFilenameTime(item.filename) || item.created_at)}</span>
                            </div>
                        </div>
                        <span class="text-xs font-mono text-gray-600 bg-gray-900 px-2 py-1 rounded">ID: ${item.id}</span>
                    </div>
                    
                    <div class="flex-1 mb-4">
                        <p class="text-gray-400 text-sm leading-relaxed line-clamp-3">${summary}</p>
                    </div>
                    
                    <div class="space-y-2 mt-auto pt-4 border-t border-gray-800/50">
                        <div class="flex flex-wrap gap-2">
                            ${speakerTags || '<span class="text-xs text-gray-600">æ— è¯´è¯äºº</span>'}
                        </div>
                        ${emotionTags ? `<div class="flex flex-wrap gap-2 pt-2 border-t border-gray-800/30">
                            ${emotionTags}
                        </div>` : ''}
                    </div>
                </div>`;
            });

            // åœ¨å®¹å™¨é¡¶éƒ¨æ’å…¥æ–°HTML
            container.insertAdjacentHTML('afterbegin', html);
        }

        // åœ¨èŠå¤©è§†å›¾é¡¶éƒ¨æ·»åŠ æ–°é¡¹
        function prependToChat(newItems) {
            const container = document.getElementById('chat-content');
            if (!container) return;

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groups = {};
            newItems.forEach(item => {
                if (!groups[item.date_group]) groups[item.date_group] = [];
                groups[item.date_group].push(item);
            });

            let html = "";
            Object.keys(groups).sort().reverse().forEach(date => {
                // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦å·²ç»å­˜åœ¨
                const existingDateHeader = container.querySelector(`[data-date="${date}"]`);

                // å¯¹åŒä¸€å¤©å†…çš„è®°å½•æŒ‰æ–‡ä»¶åæ—¶é—´ä¸¥æ ¼å€’åºæ’åˆ—
                groups[date].sort((a, b) => {
                    const timeA = parseFilenameTime(a.filename) || a.created_at;
                    const timeB = parseFilenameTime(b.filename) || b.created_at;
                    return new Date(timeB) - new Date(timeA);
                });

                if (!existingDateHeader) {
                    // æ—¥æœŸå¤´ä¸å­˜åœ¨ï¼Œæ·»åŠ æ—¥æœŸå¤´
                    html += `
                    <div class="relative flex items-center justify-center my-8" data-date="${date}">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-800"></div>
                        </div>
                        <div class="relative bg-gray-900 px-4 py-1 rounded-full border border-gray-800 text-xs font-medium text-gray-500">
                            ${date}
                        </div>
                    </div>`;
                }

                groups[date].forEach(item => {
                    const fileTime = parseFilenameTime(item.filename) || item.created_at;
                    const fileDate = new Date(fileTime);
                    const fileYearMonth = `${fileDate.getFullYear()}-${String(fileDate.getMonth() + 1).padStart(2, '0')}`;

                    html += `
                    <div class="mb-8 animate-fade-in" data-file-time="${fileTime}" data-year-month="${fileYearMonth}">
                        <div class="flex items-center gap-2 mb-4 px-4">
                            <i class="fa-solid fa-record-vinyl text-gray-600 text-xs"></i>
                            <span class="text-xs font-mono text-gray-500">${item.filename.replace("TermuxAudioRecording_", "").replace("recording-", "").substring(0, 30)}</span>
                            <span class="text-xs text-gray-600 ml-auto">${formatTime(fileTime)}</span>
                        </div>
                    `;

                    let lastSpk = null;
                    item.segments.forEach(seg => {
                        const style = getSpeakerStyle(seg.spk);
                        const textColor = style.match(/text-(\w+)-400/)[1];
                        const showAvatar = seg.spk !== lastSpk;
                        lastSpk = seg.spk;

                        html += `
                        <div class="flex gap-4 mb-2 ${showAvatar ? 'mt-4' : ''} px-2 hover:bg-white/5 rounded-lg transition-colors p-2 -mx-2">
                            <div class="w-10 flex-shrink-0 flex flex-col items-center">
                                ${showAvatar ? `
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-${textColor}-500 to-${textColor}-700 border-2 border-${textColor}-400/30 flex items-center justify-center shadow-lg shadow-${textColor}-500/20">
                                    <span class="text-sm font-bold text-white">${seg.spk.substring(0, 1).toUpperCase()}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                ${showAvatar ? `
                                <div class="flex items-baseline gap-2 mb-1">
                                    <span class="text-sm font-bold text-gray-200">${seg.spk.replace("TermuxAudioRecording_", "").replace("recording-", "").substring(0, 25)}</span>
                                    <span class="text-[10px] text-gray-600">${formatTime(item.created_at)}</span>
                                </div>
                                ` : ''}
                                <div class="text-gray-300 leading-relaxed text-sm flex items-start gap-2">
                                    <span class="flex-1">${seg.text}</span>
                                    ${seg.segment_audio_path && !seg.segment_audio_path.includes('temp') && seg.segment_audio_path.startsWith('/') ?
                                `<button onclick="playAudio('${seg.segment_audio_path}')" class="flex-shrink-0 w-6 h-6 rounded-full bg-primary-500/20 hover:bg-primary-500/40 border border-primary-400/30 flex items-center justify-center transition-all duration-200 hover:scale-110 group" title="æ’­æ”¾éŸ³é¢‘">
                                            <i class="fa-solid fa-play text-[10px] text-primary-300 group-hover:text-primary-200"></i>
                                        </button>` : ''}
                                    ${seg.emotion ?
                                `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium bg-purple-500/10 text-purple-300 ml-2 border border-purple-500/30">
                                            <span>${getEmotionIcon(seg.emotion)}</span>
                                            <span>${seg.emotion}</span>
                                        </span>` : ''}
                                </div>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                });
            });

            // åœ¨å®¹å™¨é¡¶éƒ¨æ’å…¥æ–°HTML
            container.insertAdjacentHTML('afterbegin', html);

            // é‡æ–°åˆå§‹åŒ–æ—¶é—´è½´ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (typeof initTimeline === 'function') {
                initTimeline();
            }
        }


        // ===== TIMELINE FUNCTIONS =====

        function initTimeline() {
            const contentEl = document.getElementById('chat-content');
            const timelineEl = document.getElementById('timeline');
            const timelineContainer = document.getElementById('timeline-container');
            const markersEl = document.getElementById('timeline-markers');
            const indicatorEl = document.getElementById('timeline-indicator');
            const hoverTooltip = document.getElementById('timeline-hover-tooltip');

            if (!contentEl || !timelineContainer) return;

            const items = Array.from(document.querySelectorAll('[data-file-time]'));
            if (items.length === 0) return;

            // Generate timeline markers
            generateTimelineMarkers(items, markersEl);

            // Get date at mouse position
            function getDateAtPosition(mouseY) {
                const rect = timelineContainer.getBoundingClientRect();
                const relativeY = mouseY - rect.top;
                const percentage = Math.max(0, Math.min(1, relativeY / rect.height));

                const itemIndex = Math.round(percentage * (items.length - 1));
                const item = items[itemIndex];

                if (item) {
                    const yearMonth = item.dataset.yearMonth;
                    return { yearMonth: yearMonth.replace('-', '/'), item };
                }

                return null;
            }

            // Handle timeline hover
            timelineContainer.addEventListener('mousemove', (e) => {
                const result = getDateAtPosition(e.clientY);
                if (result) {
                    hoverTooltip.textContent = result.yearMonth;
                    hoverTooltip.style.left = (e.clientX - 70) + 'px';
                    hoverTooltip.style.top = e.clientY + 'px';
                    hoverTooltip.style.opacity = '1';
                }
            });

            timelineContainer.addEventListener('mouseleave', () => {
                hoverTooltip.style.opacity = '0';
            });

            // Handle timeline click
            timelineContainer.addEventListener('click', (e) => {
                const result = getDateAtPosition(e.clientY);
                if (result && result.item) {
                    result.item.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });

            // Update indicator
            function updateIndicator() {
                const contentRect = contentEl.getBoundingClientRect();
                const contentTop = contentRect.top;

                let closestIndex = 0;
                let closestDistance = Infinity;

                items.forEach((item, index) => {
                    const itemRect = item.getBoundingClientRect();
                    const distance = Math.abs(itemRect.top - contentTop);

                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestIndex = index;
                    }
                });

                const percentage = (closestIndex / Math.max(items.length - 1, 1)) * 100;
                indicatorEl.style.top = `${percentage}%`;
            }

            // Scroll events
            let scrollTimeout;
            contentEl.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(updateIndicator, 10);
            });

            // Sync timeline scroll
            contentEl.addEventListener('scroll', () => {
                if (contentEl.scrollHeight > contentEl.clientHeight) {
                    const scrollPercentage = contentEl.scrollTop / (contentEl.scrollHeight - contentEl.clientHeight);
                    const timelineScrollTop = scrollPercentage * Math.max(0, timelineEl.scrollHeight - timelineEl.clientHeight);
                    timelineEl.scrollTop = timelineScrollTop;
                }
            });

            updateIndicator();
        }

        function generateTimelineMarkers(items, markersEl) {
            markersEl.innerHTML = '';

            // Group by year and month from file times
            const yearMonthGroups = {};
            items.forEach((item, index) => {
                const yearMonth = item.dataset.yearMonth;
                if (!yearMonth) return;

                const [year, month] = yearMonth.split('-');

                if (!yearMonthGroups[year]) {
                    yearMonthGroups[year] = {};
                }
                if (!yearMonthGroups[year][month]) {
                    yearMonthGroups[year][month] = { count: 0, firstIndex: index };
                }
                yearMonthGroups[year][month].count++;
            });

            // Sort years descending
            const years = Object.keys(yearMonthGroups).sort((a, b) => b - a);

            years.forEach((year, yearIndex) => {
                // Year label
                const yearLabel = document.createElement('div');
                yearLabel.className = 'timeline-year text-center mb-3';
                yearLabel.textContent = year;
                markersEl.appendChild(yearLabel);

                // Months sorted descending
                const months = Object.keys(yearMonthGroups[year]).sort((a, b) => b - a);

                // Create dots for each file in each month
                months.forEach((month) => {
                    const fileCount = yearMonthGroups[year][month].count;

                    // Add one dot per file in this month
                    for (let i = 0; i < fileCount; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'timeline-dot mx-auto my-1';
                        markersEl.appendChild(dot);
                    }

                    // Add small spacing between months
                    if (months.indexOf(month) < months.length - 1) {
                        const monthSpacer = document.createElement('div');
                        monthSpacer.className = 'h-2';
                        markersEl.appendChild(monthSpacer);
                    }
                });

                // Spacing between years
                if (yearIndex < years.length - 1) {
                    const spacer = document.createElement('div');
                    spacer.className = 'h-6';
                    markersEl.appendChild(spacer);
                }
            });
        }

        // æ¸²æŸ“åˆ†æè§†å›¾
        function renderAnalysis(items) {
            const container = document.getElementById('analysis-content');

            // ç»Ÿè®¡æ•°æ®
            const stats = {};
            allItems.forEach(item => {
                item.segments.forEach(seg => {
                    if (!stats[seg.spk]) {
                        stats[seg.spk] = { count: 0, words: 0, emotions: {} };
                    }
                    stats[seg.spk].count++;
                    stats[seg.spk].words += seg.text.length;

                    const emo = seg.emotion || 'neutral';
                    stats[seg.spk].emotions[emo] = (stats[seg.spk].emotions[emo] || 0) + 1;
                });
            });

            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const sortedStats = Object.entries(stats)
                .sort((a, b) => b[1].count - a[1].count);

            let html = "";

            // æ¦‚è§ˆå¡ç‰‡
            html += `
            <div class="col-span-1 lg:col-span-2 glass-card rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-bold text-white mb-4">è¯´è¯äººæ´»è·ƒåº¦æ’è¡Œ</h3>
                <div class="space-y-4">
            `;

            sortedStats.forEach(([spk, data], index) => {
                const style = getSpeakerStyle(spk);
                const colorName = style.match(/text-(\w+)-400/)[1];
                const percent = Math.min(100, (data.count / sortedStats[0][1].count) * 100);

                html += `
                <div class="relative">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium text-gray-300 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-${colorName}-500"></span>
                            ${spk}
                        </span>
                        <span class="text-gray-500 font-mono">${data.count} å¥ / ${data.words} å­—</span>
                    </div>
                    <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full bg-${colorName}-500 rounded-full transition-all duration-1000" style="width: ${percent}%"></div>
                    </div>
                </div>
                `;
            });
            html += `</div></div>`;

            // æƒ…æ„Ÿåˆ†å¸ƒ (æ¨¡æ‹Ÿå›¾è¡¨ï¼Œå®é™…å¯ä»¥ç”¨Chart.js)
            html += `
            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-lg font-bold text-white mb-4">æƒ…æ„Ÿåˆ†å¸ƒ</h3>
                <div class="grid grid-cols-2 gap-4">
            `;

            // æ±‡æ€»æ‰€æœ‰æƒ…æ„Ÿ
            const allEmotions = {};
            Object.values(stats).forEach(s => {
                Object.entries(s.emotions).forEach(([e, c]) => {
                    allEmotions[e] = (allEmotions[e] || 0) + c;
                });
            });

            Object.entries(allEmotions).forEach(([emo, count]) => {
                html += `
                <div class="bg-gray-800/50 rounded-xl p-3 border border-gray-700/50 text-center">
                    <div class="text-2xl mb-1">${getEmotionIcon(emo)}</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wider">${emo}</div>
                    <div class="text-lg font-bold text-white">${count}</div>
                </div>
                `;
            });

            html += `</div></div>`;

            container.innerHTML = html;
        }

        function getEmotionIcon(emo) {
            const map = {
                'happy': 'ğŸ˜Š', 'sad': 'ğŸ˜”', 'angry': 'ğŸ˜¡', 'neutral': 'ğŸ˜',
                'laughter': 'ğŸ¤£', 'fearful': 'ğŸ˜¨', 'surprised': 'ğŸ˜²'
            };
            return map[emo] || 'ğŸ˜¶';
        }

        // åŠ è½½æ›´å¤šæ•°æ®
        // æ—¥æœŸç­›é€‰åŠŸèƒ½
        let currentStartDate = null;
        let currentEndDate = null;

        // æ›´æ–°æ—¥æœŸèŒƒå›´æ˜¾ç¤º
        function updateDateRangeDisplay() {
            const rangeText = document.getElementById('chat-date-range-text');
            if (!rangeText) return;

            if (currentStartDate && currentEndDate) {
                rangeText.textContent = `${currentStartDate} è‡³ ${currentEndDate}`;
            } else {
                rangeText.textContent = 'æ‰€æœ‰è®°å½•';
            }
        }

        function applyDateFilter() {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;

            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ');
                return;
            }

            if (startDate > endDate) {
                alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }

            currentStartDate = startDate;
            currentEndDate = endDate;

            // é‡ç½®åˆ†é¡µå¹¶é‡æ–°åŠ è½½æ•°æ®
            currentOffset = 0;
            allItems = [];
            hasMore = true;

            loadFilteredData();
            updateDateRangeDisplay();
        }

        function clearDateFilter() {
            currentStartDate = null;
            currentEndDate = null;
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';

            // é‡ç½®å¹¶é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
            currentOffset = 0;
            allItems = [];
            hasMore = true;

            loadMore();
            updateDateRangeDisplay();
        }

        async function loadFilteredData() {
            if (isLoading || !hasMore) return;
            isLoading = true;
            document.getElementById('loading-indicator').classList.remove('hidden');

            try {
                let url;
                if (currentStartDate && currentEndDate) {
                    // ä½¿ç”¨æ—¶é—´èŒƒå›´API
                    url = `/api/data/range?start_date=${currentStartDate}&end_date=${currentEndDate}&offset=${currentOffset}&limit=${pageSize}`;
                } else {
                    // ä½¿ç”¨æ™®é€šAPI
                    url = `/api/data?offset=${currentOffset}&limit=${pageSize}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                let newItems;
                if (data.transcripts) {
                    // æ—¶é—´èŒƒå›´APIè¿”å›æ ¼å¼
                    newItems = data.transcripts;
                    hasMore = data.meta && data.meta.returned_count === pageSize;
                } else {
                    // æ™®é€šAPIè¿”å›æ ¼å¼
                    newItems = Array.isArray(data) ? data : [];
                    hasMore = newItems.length === pageSize;
                }

                if (newItems.length === 0) {
                    hasMore = false;
                    if (currentOffset === 0) {
                        document.getElementById('dashboard-content').innerHTML =
                            '<div class="col-span-full text-center py-20"><i class="fa-solid fa-inbox text-6xl text-gray-700 mb-4"></i><p class="text-gray-500 text-lg">æ‰€é€‰æ—¶é—´èŒƒå›´å†…æ²¡æœ‰æ‰¾åˆ°å¯¹è¯è®°å½•</p></div>';
                    }
                } else {
                    allItems = allItems.concat(newItems);
                    currentOffset += newItems.length;

                    const processed = processStats(allItems);
                    renderDashboard(processed);
                    renderChat(processed);
                    renderAnalysis(processed);
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
            } finally {
                isLoading = false;
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        async function loadMore() {
            if (isLoading || !hasMore) return;

            isLoading = true;
            document.getElementById('loading-indicator').classList.remove('hidden');

            try {
                const dataRes = await fetch(`/api/data?offset=${currentOffset}&limit=${pageSize}`);
                let newItems = await dataRes.json();

                if (newItems.length === 0) {
                    hasMore = false;
                    document.getElementById('loading-indicator').classList.add('hidden');
                    return;
                }

                if (newItems.length < pageSize) {
                    hasMore = false;
                }

                newItems = processStats(newItems);

                // è¿½åŠ æ–°æ•°æ®
                allItems = allItems.concat(newItems);
                currentOffset += newItems.length;

                // é‡æ–°æ¸²æŸ“æ‰€æœ‰è§†å›¾
                renderDashboard(allItems); // ä»ªè¡¨ç›˜æ”¯æŒè¿½åŠ 
                renderChat(allItems);      // èŠå¤©å…¨é‡é‡ç»˜
                renderAnalysis(allItems);  // åˆ†æå…¨é‡é‡ç»˜

            } catch (e) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
            } finally {
                isLoading = false;
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        async function updateLoop() {
            try {
                const statusRes = await fetch('/api/status');
                const statusData = await statusRes.json();

                const asrDot = document.getElementById('status-asr');
                if (statusData.asr_server === 'online') {
                    asrDot.classList.remove('text-red-500');
                    asrDot.classList.add('text-green-500', 'shadow-[0_0_8px_#22c55e]');
                } else {
                    asrDot.classList.remove('text-green-500', 'shadow-[0_0_8px_#22c55e]');
                    asrDot.classList.add('text-red-500');
                }

                document.getElementById('status-files').innerText = statusData.pending_files;
                document.getElementById('log-display').innerText = statusData.last_log || "æ— æ—¥å¿—";

                // å¦‚æœå½“å‰å¤„äºç­›é€‰æ¨¡å¼ï¼Œä¸è¿›è¡Œè‡ªåŠ¨åˆ·æ–°ï¼ˆé¿å…å¹²æ‰°ï¼‰
                if (currentStartDate && currentEndDate) {
                    console.log('ç­›é€‰æ¨¡å¼ä¸‹è·³è¿‡è‡ªåŠ¨åˆ·æ–°');
                    return;
                }

                // åªæ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®ï¼ˆæ£€æŸ¥æœ€æ–°ä¸€æ¡ï¼‰
                const checkRes = await fetch('/api/data?offset=0&limit=1');
                let checkData = await checkRes.json();

                // å¤„ç†ä¸åŒçš„APIè¿”å›æ ¼å¼
                let latestItem;
                if (checkData.transcripts) {
                    // æ—¶é—´èŒƒå›´APIè¿”å›æ ¼å¼
                    latestItem = checkData.transcripts;
                } else {
                    // æ™®é€šAPIè¿”å›æ ¼å¼
                    latestItem = checkData;
                }

                if (latestItem.length > 0) {
                    const latestId = latestItem[0].id;
                    const currentLatestId = allItems.length > 0 ? allItems[0].id : null;

                    // å¦‚æœæœ‰æ–°æ•°æ®ï¼Œåªè·å–æ–°å¢çš„é¡¹
                    if (latestId !== currentLatestId) {
                        console.log('æ£€æµ‹åˆ°æ–°æ•°æ®ï¼Œå¢é‡åŠ è½½');

                        // è®¡ç®—éœ€è¦è·å–å¤šå°‘æ¡æ–°æ•°æ®
                        // ç®€å•ç­–ç•¥ï¼šè·å–æœ€å¤š20æ¡æ–°æ•°æ®
                        let fetchUrl;
                        if (currentStartDate && currentEndDate) {
                            fetchUrl = `/api/data/range?start_date=${currentStartDate}&end_date=${currentEndDate}&offset=0&limit=20`;
                        } else {
                            fetchUrl = '/api/data?offset=0&limit=20';
                        }

                        const newDataRes = await fetch(fetchUrl);
                        let newData = await newDataRes.json();

                        // å¤„ç†ä¸åŒçš„APIè¿”å›æ ¼å¼
                        let newItems;
                        if (newData.transcripts) {
                            newItems = newData.transcripts;
                        } else {
                            newItems = newData;
                        }

                        // è¿‡æ»¤å‡ºçœŸæ­£çš„æ–°é¡¹ï¼ˆIDå¤§äºå½“å‰æœ€æ–°IDçš„ï¼‰
                        const reallyNewItems = [];
                        for (const item of newItems) {
                            if (currentLatestId === null || item.id > currentLatestId) {
                                reallyNewItems.push(item);
                            } else {
                                break; // é‡åˆ°å·²å­˜åœ¨çš„é¡¹å°±åœæ­¢
                            }
                        }

                        if (reallyNewItems.length > 0) {
                            // å¤„ç†æ–°é¡¹çš„ç»Ÿè®¡æ•°æ®
                            const processedNewItems = processStats(reallyNewItems);

                            // å°†æ–°é¡¹æ’å…¥åˆ° allItems çš„å¼€å¤´
                            allItems = processedNewItems.concat(allItems);
                            currentOffset += reallyNewItems.length;

                            // å¢é‡æ¸²æŸ“ï¼šåªæ·»åŠ æ–°å¡ç‰‡åˆ°é¡¶éƒ¨
                            prependNewItems(processedNewItems);

                            console.log(`å¢é‡åŠ è½½äº† ${reallyNewItems.length} æ¡æ–°æ•°æ®`);
                        }
                    }
                }

            } catch (e) { console.error(e); }
        }

        // æ·»åŠ æ»šåŠ¨ç›‘å¬ - æ»šåŠ¨åˆ°åº•éƒ¨æ—¶åŠ è½½æ›´å¤š
        ['view-dashboard', 'view-chat', 'view-analysis'].forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.addEventListener('scroll', () => {
                    if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
                        // å¦‚æœæœ‰æ—¥æœŸç­›é€‰ï¼Œä½¿ç”¨ç­›é€‰åŠ è½½ï¼›å¦åˆ™ä½¿ç”¨æ™®é€šåŠ è½½
                        if (currentStartDate && currentEndDate) {
                            loadFilteredData();
                        } else {
                            loadMore();
                        }
                    }
                });
            }
        });


        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filter-start-date').value = today;
        document.getElementById('filter-end-date').value = today;

        // åˆå§‹åŠ è½½
        loadMore();
        // å®šæ—¶æ£€æŸ¥æ–°æ•°æ®
        setInterval(updateLoop, 5000);

        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        function toggleMobileMenu() {
            const aside = document.querySelector('aside');
            const overlay = document.querySelector('.mobile-overlay');

            aside.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        // ç‚¹å‡»å¯¼èˆªæŒ‰é’®åè‡ªåŠ¨å…³é—­ç§»åŠ¨ç«¯èœå•
        const originalSwitchTab = switchTab;
        switchTab = function (tabName) {
            originalSwitchTab(tabName);

            // å¦‚æœæ˜¯ç§»åŠ¨ç«¯,å…³é—­èœå•
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
        };


        // å£°çº¹ç®¡ç†ç›¸å…³å‡½æ•°
        document.getElementById('audio-file')?.addEventListener('change', function (e) {
            const fileName = e.target.files[0]?.name || 'ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶';
            document.getElementById('file-name').textContent = fileName;
        });

        // æ³¨å†Œå£°çº¹
        document.getElementById('register-form')?.addEventListener('submit', async function (e) {
            e.preventDefault();

            const name = document.getElementById('speaker-name').value;
            const file = document.getElementById('audio-file').files[0];
            const statusDiv = document.getElementById('register-status');

            if (!name || !file) {
                showStatus('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('speaker_name', name);
            formData.append('audio_file', file);

            showStatus('æ­£åœ¨æ³¨å†Œ...', 'loading');

            try {
                const response = await fetch('/speaker/register', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('âœ… æ³¨å†ŒæˆåŠŸ!', 'success');
                    document.getElementById('register-form').reset();
                    document.getElementById('file-name').textContent = 'ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶';
                    loadSpeakers();
                } else {
                    showStatus('âŒ ' + (result.error || 'æ³¨å†Œå¤±è´¥'), 'error');
                }
            } catch (error) {
                showStatus('âŒ ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        });

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('register-status');
            statusDiv.className = 'mt-4 p-4 rounded-xl ' +
                (type === 'success' ? 'bg-green-500/10 border border-green-500/30 text-green-400' :
                    type === 'error' ? 'bg-red-500/10 border border-red-500/30 text-red-400' :
                        'bg-blue-500/10 border border-blue-500/30 text-blue-400');
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');

            if (type !== 'loading') {
                setTimeout(() => statusDiv.classList.add('hidden'), 5000);
            }
        }

        // åŠ è½½è¯´è¯äººåˆ—è¡¨
        async function loadSpeakers() {
            try {
                const response = await fetch('/speaker/list');
                const data = await response.json();

                const container = document.getElementById('speaker-list');
                if (!data.speakers || data.speakers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">æš‚æ— å·²æ³¨å†Œè¯´è¯äºº</p>';
                    return;
                }

                container.innerHTML = data.speakers.map(speaker => `
                    <div class="glass-card p-6 rounded-xl hover:scale-105 transition-transform">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center">
                                    <i class="fa-solid fa-user text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-white">${speaker.name}</h4>
                                    <p class="text-xs text-gray-500">${speaker.sample_count || 0} ä¸ªæ ·æœ¬</p>
                                </div>
                            </div>
                        </div>
                        <button 
                            onclick="deleteSpeaker('${speaker.name}')"
                            class="w-full px-4 py-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-400 rounded-lg transition-all flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-trash"></i>
                            <span>åˆ é™¤</span>
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½è¯´è¯äººåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åˆ é™¤è¯´è¯äºº
        async function deleteSpeaker(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è¯´è¯äºº "${name}" å—?`)) return;

            try {
                const response = await fetch(`/speaker/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadSpeakers();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        // åˆ‡æ¢åˆ°å£°çº¹ç®¡ç†æ—¶åŠ è½½åˆ—è¡¨
        const originalSwitchTab2 = switchTab;
        switchTab = function (tabName) {
            originalSwitchTab2(tabName);
            if (tabName === 'speaker') {
                loadSpeakers();
            }
        };
        // Audio preview functionality
        let currentAudio = null;

        function playAudio(audioPath) {
            // Stop current audio if playing
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            // Create and play new audio
            currentAudio = new Audio(audioPath);
            currentAudio.play().catch(err => {
                console.error('Audio playback failed:', err);
                alert('éŸ³é¢‘æ’­æ”¾å¤±è´¥: ' + err.message);
            });

            // Clean up when finished
            currentAudio.onended = () => {
                currentAudio = null;
            };
        }




    </script>
</body>

</html>